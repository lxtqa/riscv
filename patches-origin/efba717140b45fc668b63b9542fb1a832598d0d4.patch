From efba717140b45fc668b63b9542fb1a832598d0d4 Mon Sep 17 00:00:00 2001
From: Lu Yahan <yahan@iscas.ac.cn>
Date: Mon, 9 Oct 2023 15:47:23 +0800
Subject: [PATCH] [riscv] Fix the problem of writing out of bounds memory

Change-Id: I2feeedbd86d1af2179a13511d36a5d09aa424ea6
Reviewed-on: https://chromium-review.googlesource.com/c/v8/v8/+/4921511
Commit-Queue: Yahan Lu <yahan@iscas.ac.cn>
Commit-Queue: Ji Qiu <qiuji@iscas.ac.cn>
Reviewed-by: Ji Qiu <qiuji@iscas.ac.cn>
Cr-Commit-Position: refs/heads/main@{#90317}
---
 test/cctest/test-assembler-riscv32.cc | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/test/cctest/test-assembler-riscv32.cc b/test/cctest/test-assembler-riscv32.cc
index bc83656ad28..dd7ab94599e 100644
--- a/test/cctest/test-assembler-riscv32.cc
+++ b/test/cctest/test-assembler-riscv32.cc
@@ -1892,7 +1892,7 @@ TEST(RVV_VFNEG_signaling_NaN) {
         width == 32 ? __ flw(ft0, a0, 0) : __ fld(ft0, a0, 0);               \
         __ vl(v1, a1, 0, VSew::E##width);                                    \
         __ instr_name(reg1, reg2);                                           \
-        __ fsd(ft0, a0, 0);                                                  \
+        width == 32 ? __ fsw(ft0, a0, 0) : __ fsd(ft0, a0, 0);               \
         __ vs(v1, a1, 0, VSew::E##width);                                    \
       };                                                                     \
       GenAndRunTest<int32_t, int32_t>((int32_t)&rs1_fval, (int32_t)res, fn); \
@@ -1913,7 +1913,7 @@ TEST(RVV_VFNEG_signaling_NaN) {
       width == 32 ? __ flw(ft0, a0, 0) : __ fld(ft0, a0, 0);                 \
       __ vl(v1, a1, 0, VSew::E##width);                                      \
       __ instr_name(reg1, reg2);                                             \
-      __ fsd(ft0, a0, 0);                                                    \
+      width == 32 ? __ fsw(ft0, a0, 0) : __ fsd(ft0, a0, 0);                 \
       __ vs(v1, a1, 0, VSew::E##width);                                      \
     };                                                                       \
     GenAndRunTest<int32_t, int32_t>((int32_t)&rs1_fval, (int32_t)res, fn);   \
@@ -2507,7 +2507,8 @@ UTEST_RVV_FMA_VF_FORM_WITH_RES(vfnmsac_vf, ARRAY_FLOAT,
       __ instr_name(v0, v2, v4);                                       \
       __ VU.set(t0, VSew::E64, Vlmul::m1);                             \
       __ li(a0, Operand(int32_t(&result)));                            \
-      __ vs(v0, a0, 0, VSew::E64);                                     \
+      __ vfmv_fs(fa0, v0);                                             \
+      __ fsd(fa0, a0, 0);                                              \
     };                                                                 \
     for (float rs1_fval : compiler::ValueHelper::GetVector<float>()) { \
       std::vector<double> temp_arr(kRvvVLEN / 32,                      \
-- 
2.35.1

