From a8729a8f5d5d60d0766d26158c02d5605522b330 Mon Sep 17 00:00:00 2001
From: Lu Yahan <yahan@iscas.ac.cn>
Date: Thu, 28 Sep 2023 10:55:46 +0800
Subject: [PATCH] [riscv] Fix wasm/regress-1484978/ rvv aligned failed

Change-Id: I2ab3f703f7990f3b97fe87e7abb94b4955b08116
Reviewed-on: https://chromium-review.googlesource.com/c/v8/v8/+/4898230
Reviewed-by: Ji Qiu <qiuji@iscas.ac.cn>
Auto-Submit: Yahan Lu <yahan@iscas.ac.cn>
Commit-Queue: Ji Qiu <qiuji@iscas.ac.cn>
Cr-Commit-Position: refs/heads/main@{#90162}
---
 src/wasm/baseline/riscv/liftoff-assembler-riscv.h | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/wasm/baseline/riscv/liftoff-assembler-riscv.h b/src/wasm/baseline/riscv/liftoff-assembler-riscv.h
index 4aa3cd100ad..8cf97c40808 100644
--- a/src/wasm/baseline/riscv/liftoff-assembler-riscv.h
+++ b/src/wasm/baseline/riscv/liftoff-assembler-riscv.h
@@ -1485,6 +1485,8 @@ void LiftoffAssembler::emit_i32x4_dot_i8x16_i7x16_add_s(LiftoffRegister dst,
                                                         LiftoffRegister acc) {
   VU.set(kScratchReg, E8, m1);
   VRegister intermediate = kSimd128ScratchReg3;
+  VRegister kSimd128ScratchReg4 =
+      GetUnusedRegister(LiftoffRegList{LiftoffRegister(ft10)}).fp().toV();
   vwmul_vv(intermediate, lhs.fp().toV(), rhs.fp().toV());  // i16*16 v8 v9
 
   constexpr int32_t FIRST_INDEX = 0b0001000100010001;
@@ -1501,7 +1503,7 @@ void LiftoffAssembler::emit_i32x4_dot_i8x16_i7x16_add_s(LiftoffRegister dst,
   vcompress_vv(v0, intermediate, kSimd128ScratchReg2);  // i16*4 b
 
   VU.set(kScratchReg, E16, m1);
-  vwadd_vv(dst.fp().toV(), kSimd128ScratchReg, v0);  // i32*4 c
+  vwadd_vv(kSimd128ScratchReg4, kSimd128ScratchReg, v0);  // i32*4 c
 
   VU.set(kScratchReg, E16, m2);
   li(kScratchReg, THIRD_INDEX);
@@ -1516,7 +1518,7 @@ void LiftoffAssembler::emit_i32x4_dot_i8x16_i7x16_add_s(LiftoffRegister dst,
   vwadd_vv(kSimd128ScratchReg3, kSimd128ScratchReg, v0);  // i32*4 c
 
   VU.set(kScratchReg, E32, m1);
-  vadd_vv(dst.fp().toV(), dst.fp().toV(), kSimd128ScratchReg3);
+  vadd_vv(dst.fp().toV(), kSimd128ScratchReg4, kSimd128ScratchReg3);
   vadd_vv(dst.fp().toV(), dst.fp().toV(), acc.fp().toV());
 }
 
-- 
2.35.1

