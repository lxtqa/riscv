From e9df29e3681080eda9c419a7b5a57d16abe357b4 Mon Sep 17 00:00:00 2001
From: QiuJi <qiuji@iscas.ac.cn>
Date: Thu, 6 May 2021 17:38:37 +0800
Subject: [PATCH] [riscv64] Make disassembler recognize illegal inst

Bug:
Change-Id: If5cb112f838e73bcec5e9971a12e1f88ab41e996
Reviewed-on: https://chromium-review.googlesource.com/c/v8/v8/+/2874399
Reviewed-by: Brice Dobry <brice.dobry@futurewei.com>
Commit-Queue: Brice Dobry <brice.dobry@futurewei.com>
Cr-Commit-Position: refs/heads/master@{#74549}
---
 src/codegen/riscv64/constants-riscv64.cc | 3 +++
 src/codegen/riscv64/constants-riscv64.h  | 5 +++++
 2 files changed, 8 insertions(+)

diff --git a/src/codegen/riscv64/constants-riscv64.cc b/src/codegen/riscv64/constants-riscv64.cc
index e77a65e33b..d2709dc2c7 100644
--- a/src/codegen/riscv64/constants-riscv64.cc
+++ b/src/codegen/riscv64/constants-riscv64.cc
@@ -106,6 +106,9 @@ int FPURegisters::Number(const char* name) {
 }
 
 InstructionBase::Type InstructionBase::InstructionType() const {
+  if (IsIllegalInstruction()) {
+    return kUnsupported;
+  }
   // RV64C Instruction
   if (FLAG_riscv_c_extension && IsShortInstruction()) {
     switch (InstructionBits() & kRvcOpcodeMask) {
diff --git a/src/codegen/riscv64/constants-riscv64.h b/src/codegen/riscv64/constants-riscv64.h
index cb34ae479b..c8f54d8f7f 100644
--- a/src/codegen/riscv64/constants-riscv64.h
+++ b/src/codegen/riscv64/constants-riscv64.h
@@ -727,6 +727,11 @@ class InstructionBase {
     kUnsupported = -1
   };
 
+  inline bool IsIllegalInstruction() const {
+    uint8_t FirstHalfWord = *reinterpret_cast<const uint16_t*>(this);
+    return FirstHalfWord == 0;
+  }
+
   inline bool IsShortInstruction() const {
     uint8_t FirstByte = *reinterpret_cast<const uint8_t*>(this);
     return (FirstByte & 0x03) <= C2;
-- 
2.35.1

