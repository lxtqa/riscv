From 59d7cf5259df9ad380574b0f3630f69d747df454 Mon Sep 17 00:00:00 2001
From: Lu Yahan <yahan@iscas.ac.cn>
Date: Thu, 25 Aug 2022 10:52:28 +0800
Subject: [PATCH] [riscv] Port [heap] Add shared barrier to RecordWrite builtin

Bug: v8:11708

Change-Id: I803b5499f1bbc3f7b4e626628a73f98239df8454
Reviewed-on: https://chromium-review.googlesource.com/c/v8/v8/+/3854435
Auto-Submit: Yahan Lu <yahan@iscas.ac.cn>
Commit-Queue: ji qiu <qiuji@iscas.ac.cn>
Reviewed-by: ji qiu <qiuji@iscas.ac.cn>
Cr-Commit-Position: refs/heads/main@{#82710}
---
 src/codegen/riscv/macro-assembler-riscv.cc         | 4 ++--
 src/compiler/backend/riscv/code-generator-riscv.cc | 7 ++++---
 2 files changed, 6 insertions(+), 5 deletions(-)

diff --git a/src/codegen/riscv/macro-assembler-riscv.cc b/src/codegen/riscv/macro-assembler-riscv.cc
index 59115e21cc..bb3bc269ed 100644
--- a/src/codegen/riscv/macro-assembler-riscv.cc
+++ b/src/codegen/riscv/macro-assembler-riscv.cc
@@ -420,14 +420,14 @@ void MacroAssembler::RecordWrite(Register object, Operand offset,
     Register temp = temps.Acquire();
     CheckPageFlag(value,
                   temp,  // Used as scratch.
-                  MemoryChunk::kPointersToHereAreInterestingMask,
+                  MemoryChunk::kPointersToHereAreInterestingOrInSharedHeapMask,
                   eq,  // In RISC-V, it uses cc for a comparison with 0, so if
                        // no bits are set, and cc is eq, it will branch to done
                   &done);
 
     CheckPageFlag(object,
                   temp,  // Used as scratch.
-                  MemoryChunk::kPointersFromHereAreInterestingMask,
+                  MemoryChunk::kPointersToHereAreInterestingOrInSharedHeapMask,
                   eq,  // In RISC-V, it uses cc for a comparison with 0, so if
                        // no bits are set, and cc is eq, it will branch to done
                   &done);
diff --git a/src/compiler/backend/riscv/code-generator-riscv.cc b/src/compiler/backend/riscv/code-generator-riscv.cc
index 1466128e1e..40d61e48f7 100644
--- a/src/compiler/backend/riscv/code-generator-riscv.cc
+++ b/src/compiler/backend/riscv/code-generator-riscv.cc
@@ -176,9 +176,10 @@ class OutOfLineRecordWrite final : public OutOfLineCode {
       __ DecompressTaggedPointer(value_, value_);
     }
 #endif
-    __ CheckPageFlag(value_, scratch0_,
-                     MemoryChunk::kPointersToHereAreInterestingMask, eq,
-                     exit());
+    __ CheckPageFlag(
+        value_, scratch0_,
+        MemoryChunk::kPointersToHereAreInterestingOrInSharedHeapMask, eq,
+        exit());
     __ AddWord(scratch1_, object_, index_);
     SaveFPRegsMode const save_fp_mode = frame()->DidAllocateDoubleRegisters()
                                             ? SaveFPRegsMode::kSave
-- 
2.35.1

